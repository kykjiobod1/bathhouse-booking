from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from asgiref.sync import sync_to_async
from bathhouse_booking.bookings.models import SystemConfig, Client
import logging

logger = logging.getLogger(__name__)

router = Router()

class MessageAdminStates(StatesGroup):
    waiting_for_message = State()

async def get_admin_telegram_id():
    """–ü–æ–ª—É—á–∏—Ç—å Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ SystemConfig"""
    try:
        config = await sync_to_async(SystemConfig.objects.get)(key="TELEGRAM_ADMIN_ID")
        return config.value if config.value else None
    except SystemConfig.DoesNotExist:
        return None

@router.callback_query(lambda c: c.data == "message_admin")
async def start_message_admin(callback: types.CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    admin_id = await get_admin_telegram_id()
    
    if not admin_id:
        await callback.message.edit_text(
            "‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º."
        )
        return
    
    await state.set_state(MessageAdminStates.waiting_for_message)
    await callback.message.edit_text(
        "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è.\n"
        "–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–∂–º–∏—Ç–µ /cancel"
    )

@router.message(Command("cancel"), MessageAdminStates.waiting_for_message)
async def cancel_message(message: types.Message, state: FSMContext):
    """–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è"""
    await state.clear()
    await message.answer("‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

@router.message(MessageAdminStates.waiting_for_message)
async def forward_to_admin(message: types.Message, state: FSMContext, bot):
    """–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"""
    admin_id = await get_admin_telegram_id()
    
    if not admin_id:
        await message.answer("‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω.")
        await state.clear()
        return
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
        client, created = await sync_to_async(Client.objects.get_or_create)(
            telegram_id=str(message.from_user.id),
            defaults={
                'name': message.from_user.full_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π',
                'phone': ''
            }
        )
        
        # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        forwarded_msg = await message.forward(chat_id=admin_id)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ
        client_info = (
            f"\n\nüë§ –û—Ç: {client.name}\n"
            f"Telegram ID: {client.telegram_id}\n"
            f"–¢–µ–ª–µ—Ñ–æ–Ω: {client.phone or '–Ω–µ —É–∫–∞–∑–∞–Ω'}"
        )
        
        await bot.send_message(
            chat_id=admin_id,
            text=client_info,
            reply_to_message_id=forwarded_msg.message_id
        )
        
        await message.answer(
            "‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É!\n"
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å."
        )
        
        await state.clear()
        
    except Exception as e:
        logger.error(f"Failed to forward message to admin: {e}")
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
        await state.clear()

@router.message(F.reply_to_message)
async def handle_admin_reply(message: types.Message, bot):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        replied_msg = message.reply_to_message
        
        if not replied_msg:
            return
        
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ original_sender_id —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
        original_sender_id = None
        
        # –°–ø–æ—Å–æ–± 1: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if replied_msg.forward_from:
            original_sender_id = replied_msg.forward_from.id
            logger.info(f"Found sender via forward_from: {original_sender_id}")
        
        # –°–ø–æ—Å–æ–± 2: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∏–µ–Ω—Ç–µ,
        # –∫–æ—Ç–æ—Ä–æ–µ —Å–∞–º–æ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        elif replied_msg.reply_to_message and replied_msg.reply_to_message.forward_from:
            original_sender_id = replied_msg.reply_to_message.forward_from.id
            logger.info(f"Found sender via reply_to_message.forward_from: {original_sender_id}")
        
        # –°–ø–æ—Å–æ–± 3: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∏–µ–Ω—Ç–µ,
        # –≤ –∫–æ—Ç–æ—Ä–æ–º –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ Telegram ID –≤ —Ç–µ–∫—Å—Ç–µ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
        if not original_sender_id and replied_msg.text:
            import re
            # –ò—â–µ–º Telegram ID –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Telegram ID: 123456")
            match = re.search(r'Telegram ID:\s*(\d+)', replied_msg.text)
            if match:
                original_sender_id = match.group(1)
                logger.info(f"Found sender via text parsing: {original_sender_id}")
        
        if not original_sender_id:
            logger.warning(f"Could not find original sender for admin reply. replied_msg: {replied_msg}")
            return
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –∫–ª–∏–µ–Ω—Ç—É
        reply_text = f"üì® –û—Ç–≤–µ—Ç –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n\n{message.text or 'üìé (—Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–ª–æ–∂–µ–Ω–∏–µ–º)'}"
        
        await bot.send_message(
            chat_id=original_sender_id,
            text=reply_text
        )
        
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É, —á—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        await message.reply("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É.")
        
        logger.info(f"Admin reply forwarded to user {original_sender_id}")
        
    except Exception as e:
        logger.error(f"Failed to handle admin reply: {e}", exc_info=True)
        await message.reply("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É.")